name: Security Pipeline (SAST, Secrets, Container)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:
    
concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # --- SAST (CodeQL for JS/TS) ---
  codeql-jsts:
    permissions:
      contents: read
      security-events: write
      
    name: SAST (CodeQL JS/TS - security-extended)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL (JS/TS)
        uses: github/codeql-action/init@v3
        with:
          languages: javascript         
          queries: +security-extended
          build-mode: none             

      - name: Analyze (JS/TS)
        uses: github/codeql-action/analyze@v3
        with:
          category: codeql-javascript

  # --- Gitleaks-Scan ---
  gitleaks-scan:
    permissions:
      contents: read
      security-events: write
      
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks (create SARIF, don't fail pipeline)
        run: |
          docker run --rm -v "$PWD:/repo" zricethezav/gitleaks:latest \
            detect --source /repo \
            --report-format sarif \
            --report-path /repo/gitleaks.sarif \
            --exit-code 0 \
            --no-banner

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gitleaks.sarif
          category: gitleaks

  # --- Container Image Tarama (Trivy) ---
  container-scan:
    permissions:
      contents: read
      security-events: write
      
    name: Container Scan (Trivy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build image
        run: |
          docker build -t app-under-test:ci .

      - name: Trivy scan (image)
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v "$PWD:/work" -w /work \
            aquasec/trivy:latest image \
            --scanners vuln \
            --format sarif \
            --output trivy.sarif \
            --exit-code 0 \
            app-under-test:ci

      - name: Upload SARIF (Trivy)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy.sarif
          category: trivy
